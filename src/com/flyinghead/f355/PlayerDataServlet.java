/*
	F355 Challenge web server revival
	Copyright (C) 2023 flyinghead

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */
package com.flyinghead.f355;

import java.io.IOException;
import java.util.Base64;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/*
 * MICHAEL
 * 000  48 83 59 3c 82 59 c8 ca 8d 23 66 c4 cc c6 e7 ce  H.Y<.Y...#f.....
 * 010  d1 24 eb d6 3e 88 b6 30 e8 b8 7e 87 d4 94 85 10  .$..>..0..~.....
 * 020  2e 3d ed 80 f4 8e 0b 79 83 4d f4 e0 39 10 e0 39  .=.....y.M..9..9
 * 030  11 87 19 00 01 00 00 00 00 00 00 00 00 00 00 00  ................
 * ...
 * 2f0  00 00 00 00 00 00 00 00 00 00 00 00 00 01 8a 1d  ................
 * 
 * FLYINGHEAD
 * 000  48 83 59 3c 8a 93 cf 8a 9e cc 8c cd 48 c3 5d cb  H.Y<........H.].
 * 010  d1 24 eb d6 11 72 d1 24 ea d4 3e e8 b8 45 88 00  .$...r.$..>..E..
 * 020  2e 3d ed 80 cc c1 43 78 81 a7 79 8c 99 cc e0 39  .=....Cx..y....9
 * 030  10 dc bd 00 06 00 00 00 00 00 00 00 00 00 00 00  ................
 * 040  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 050  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 070  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 080  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 090  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 0a0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 0b0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 0c0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03  ................
 * 0d0  7f ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  ................
 * 0e0  ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  ................
 * 0f0  ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  ................
 * 100  ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  ................
 * 110  ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  ................
 * 120  ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  ................
 * 130  ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  ................
 * 140  ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  ................
 * 150  ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff fd  ................
 * 160  10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 170  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 180  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 190  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 1a0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 1b0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 1c0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 1d0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 1e0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 1f0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 200  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 210  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 220  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 230  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 240  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 250  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 260  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 270  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 280  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 290  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 2a0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 2b0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 2c0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 2d0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 2e0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
 * 2f0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 0d 37  ...............7
 * 
 */

@WebServlet("/cgi-bin/f355/dp3_player_data.cgi")
public class PlayerDataServlet extends HttpServlet
{
	private static final long serialVersionUID = 1L;

	@Override
	protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException
	{
		String in = req.getReader().readLine();
		log("Received " + in);
		QueryParams params = new QueryParams(in);
		String strData = params.get("f355_player_data");
		if (strData == null) {
			resp.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
			log("Field f355_player_data not found");
			return;
		}
		byte[] bytes = Base64.getDecoder().decode(strData);
		log("Received " + bytes.length + " bytes");
		int i = 0;
		while (i < bytes.length)
		{
			StringBuffer hex = new StringBuffer();
			StringBuffer ascii = new StringBuffer();
			for (int j = 0; j < 16 && i + j < bytes.length; j++) {
				hex.append(String.format("%1$02x ", bytes[i + j]));
				if (bytes[i + j] >= 32 && bytes[i + j] <= 126)
					ascii.append((char)bytes[i + j]);
				else
					ascii.append('.');
			}
			log(hex + " " + ascii);
			i += 16;
		}
	}

}
